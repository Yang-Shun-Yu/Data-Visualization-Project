<!DOCTYPE html>
<meta charset="utf-8">

<head>
    <title>HW09-Spotify Tracks Dataset</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" integrity="sha512-uto9mlQzrs59VwILcLiRYeLKPPbS/bT71da/OEBYEwcdNUk8jYIy+D176RYoop1Da+f9mvkYrmj5MCLZWEtQuA==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha512-M5KW3ztuIICmVIhjSqXe01oV2bpe248gOxqmlcYrEzAvws7Pw3z6BK0iGbrwvdrUQUhi3eXgtxp5I8PDo9YfjQ==" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha512-MoRNloxbStBcD8z3M/2BmnT+rg4IsMxPkXaGh2zD6LGNNFE80W3onsAhRcMAMrSoyWL9xD7Ert0men7vR8LUZg==" crossorigin="anonymous" />
</head>

<!-- Load d3.js -->

<style type="text/css">
    body {
        background-color: #F0F0F0;
        text-align: center;
    }

    h1,
    p {
        color: #684c23;
        
        font-weight: bold;
    }
</style>

<body>
    <h1>HW09-Spotify Tracks Dataset</h1>
    <label for="rangeInput">Select +N decreasing -N increasing : </label>
    <input type="number" id="rangeInput" value="10" min="-125" max="125">
    <button onclick="updateChart()">Update Chart</button>   
</body>
<script src="https://d3js.org/d3.v6.js"></script>


<!-- Create a div where the graphs will take place -->
<div id="graphsContainer">
    <!-- Create a div for the first graph -->
    <!-- <div id="top20Graph" style="display: inline-block; margin-right: 20px;">
        <h2>Top 20 Popularity Distribution</h2>
    </div> -->
    
    <!-- Create a div for the second graph -->
    <!-- <div id="min20Graph" style="display: inline-block;">
        <h2>Bottom 20 Popularity Distribution</h2>
    </div> -->
</div>
<div id="BarChart_dataviz"></div>
<div id="Heatmap_dataviz"></div>

<script>
    function renderBarChart(svg, data, name_x, name_y, width_x, height_y,bar_color_on,bar_color_over) {
        // X axis
        const x = d3.scaleBand()
            .range([0, width_x])
            .domain(data.map(d => d[name_x]))
            .padding(0.2);

        svg.append("g")
            .attr("transform", `translate(0,${height_y})`)
            .call(d3.axisBottom(x))
            .selectAll("text")
            .attr("transform", "translate(-10,0)rotate(-45)")
            .style("text-anchor", "end");

        // Add Y axis
        const y = d3.scaleLinear()
            .domain([0, 60000])
            .range([height_y, 0]);

        svg.append("g")
            .call(d3.axisLeft(y).ticks(5));

        // Bars
        svg.selectAll("mybar")
            .data(data)
            .join("rect")
            .attr("x", d => x(d[name_x]))
            .attr("width", x.bandwidth())
            .attr("fill", bar_color_on)
            .attr("height", d => height_y - y(0))
            .attr("y", d => y(0))
             // Add hover effect
            .on("mouseover", function (event, d) {
                d3.select(this)
                    .attr("fill", bar_color_over); // Change color on hover"#4e7e4a"
                // Display specific value
                svg.append("text")
                    .attr("class", "hover-text")
                    .attr("x", x(d[name_x]) + x.bandwidth() / 2)
                    .attr("y", y(d[name_y]) - 5)
                    .attr("text-anchor", "middle")
                    .attr("font-size", "12px")
                    .text(d[name_y]);
            })
            .on("mouseout", function (event, d) {
                d3.select(this)
                    .attr("fill", bar_color_on); // Revert to original color
                // Remove the displayed value
                svg.selectAll(".hover-text").remove();
                
            });

        // Animation
        svg.selectAll("rect")
            .transition()
            .duration(300)
            .attr("y", d => y(d[name_y]))
            .attr("height", d => height_y - y(d[name_y]))
            .delay((d, i) => i * 30);
    }
    function renderHeatmap(){
        const margin = {top: 10, right: 25, bottom: 30, left: 40},
        width = 450 - margin.left - margin.right,
        height = 450 - margin.top - margin.bottom;

        // append the svg object to the body of the page
        const svg = d3.select("#Heatmap_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left}, ${margin.top})`);

        //Read the data
        d3.csv("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/heatmap_data.csv").then(function(data) {

        // Labels of row and columns -> unique identifier of the column called 'group' and 'variable'
        const myGroups = Array.from(new Set(data.map(d => d.group)))
        const myVars = Array.from(new Set(data.map(d => d.variable)))

        // Build X scales and axis:
        const x = d3.scaleBand()
            .range([ 0, width ])
            .domain(myGroups)
            .padding(0.05);
        svg.append("g")
            .style("font-size", 15)
            .attr("transform", `translate(0, ${height})`)
            .call(d3.axisBottom(x).tickSize(0))
            .select(".domain").remove()

        // Build Y scales and axis:
        const y = d3.scaleBand()
            .range([ height, 0 ])
            .domain(myVars)
            .padding(0.05);
        svg.append("g")
            .style("font-size", 15)
            .call(d3.axisLeft(y).tickSize(0))
            .select(".domain").remove()

        // Build color scale
        const myColor = d3.scaleSequential()
            .interpolator(d3.interpolateInferno)
            .domain([1,100])

        // create a tooltip
        const tooltip = d3.select("#Heatmap_dataviz")
            .append("div")
            .style("opacity", 0)
            .attr("class", "tooltip")
            .style("background-color", "white")
            .style("border", "solid")
            .style("border-width", "2px")
            .style("border-radius", "5px")
            .style("padding", "5px")

        // Three function that change the tooltip when user hover / move / leave a cell
        const mouseover = function(event,d) {
            tooltip
            .style("opacity", 1)
            d3.select(this)
            .style("stroke", "black")
            .style("opacity", 1)
        }
        const mousemove = function(event,d) {
            const tooltipX = event.pageX + 10; // Adjust the horizontal position
            const tooltipY = event.pageY - 10; // Adjust the vertical position

            tooltip
                .html("The exact value of<br>this cell is: " + d.value)
                .style("left", tooltipX + "px")
                .style("top", tooltipY + "px");
        }
        const mouseleave = function(event,d) {
            tooltip
            .style("opacity", 0)
            d3.select(this)
            .style("stroke", "none")
            .style("opacity", 0.8)
        }

        // add the squares
        svg.selectAll()
            .data(data, function(d) {return d.group+':'+d.variable;})
            .join("rect")
            .attr("x", function(d) { return x(d.group) })
            .attr("y", function(d) { return y(d.variable) })
            .attr("rx", 4)
            .attr("ry", 4)
            .attr("width", x.bandwidth() )
            .attr("height", y.bandwidth() )
            .style("fill", function(d) { return myColor(d.value)} )
            .style("stroke-width", 4)
            .style("stroke", "none")
            .style("opacity", 0.8)
            .on("mouseover", mouseover)
            .on("mousemove", mousemove)
            .on("mouseleave", mouseleave)
        })



    }

    // // Parse the Data
    // d3.csv("http://vis.lab.djosix.com:2023/data/spotify_tracks.csv").then(function (data) {
    //     const margin = { top: 30, right: 30, bottom: 80, left: 50 },
    //         width = 800 - margin.left - margin.right,
    //         height = 400 - margin.top - margin.bottom;

    //     // Create the first SVG for the top 20 graph
    //     const svgTop20 = d3.select("#top20Graph")
    //         .append("svg")
    //         .attr("width", width + margin.left + margin.right)
    //         .attr("height", height + margin.top + margin.bottom)
    //         .append("g")
    //         .attr("transform", `translate(${margin.left},${margin.top})`);

    //     // Create the second SVG for the min 20 graph
    //     const svgMin20 = d3.select("#min20Graph")
    //         .append("svg")
    //         .attr("width", width + margin.left + margin.right)
    //         .attr("height", height + margin.top + margin.bottom)
    //         .append("g")
    //         .attr("transform", `translate(${margin.left},${margin.top})`);

    //     // Use D3.js to group and sum popularity for each track_genre
    //     const genrePopularity = d3.group(data, d => d.track_genre);

    //     // Convert the grouped data back to an array of objects
    //     const genrePopularityArray = Array.from(genrePopularity, ([track_genre, entries]) => ({
    //         track_genre,
    //         popularity: d3.sum(entries, d => +d.popularity)
    //     }));

    //     // Log the result or use it as needed
    //     console.log(genrePopularityArray);

    //     // Sort the genrePopularityArray by popularity in descending order
    //     genrePopularityArray.sort((a, b) => b.popularity - a.popularity);

    //     // Take the top 20 genres
    //     const top20Genres = genrePopularityArray.slice(0, 20);
    //     // Take the bottom 20 genres (min20)
    //     genrePopularityArray.sort((a, b) => -b.popularity + a.popularity);
    //     const min20Genres = genrePopularityArray.slice(0, 20);

    //     renderBarChart(svgTop20, top20Genres, 'track_genre', 'popularity', width, height,'#d64040','#a30303');
    //     renderBarChart(svgMin20, min20Genres, 'track_genre', 'popularity', width, height,"#69b36d","#105f14");

    // })
    function updateChart() {
            d3.selectAll("#BarChart_dataviz svg").remove();
            const rangeValue = document.getElementById("rangeInput").value;
            // Fetch data and update the chart with the specified range
            // You can modify this part based on your data fetching logic
            d3.csv("http://vis.lab.djosix.com:2023/data/spotify_tracks.csv").then(function (data) {
                const margin = { top: 10, right: 30, bottom: 80, left: 50 },
                    width = 500 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;
                const svg = d3.select("#BarChart_dataviz")
                    .selectAll("svg")
                    .data([null])
                    .enter()
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Use D3.js to group and sum popularity for each track_genre
                const genrePopularity = d3.group(data, d => d.track_genre);

                // Convert the grouped data back to an array of objects
                const genrePopularityArray = Array.from(genrePopularity, ([track_genre, entries]) => ({
                    track_genre,
                    popularity: d3.sum(entries, d => +d.popularity)
                }));

                // Sort the genrePopularityArray by popularity in descending order
                if(rangeValue < 0){
                    genrePopularityArray.sort((a, b) => -b.popularity + a.popularity);
                    const minGenres = genrePopularityArray.slice(0, -rangeValue);
                    renderBarChart(svg, minGenres, 'track_genre', 'popularity', width, height,'#69b36d','#105f14');

                }else{
                    genrePopularityArray.sort((a, b) => b.popularity - a.popularity);
                    const topGenres = genrePopularityArray.slice(0, rangeValue);
                    renderBarChart(svg, topGenres, 'track_genre', 'popularity', width, height,'#d64040','#a30303');
                }
                

                // Take the top N genres based on the user input
                

                // Render the bar chart with the updated data

                
            });
        }

        // Initial chart rendering
        renderHeatmap();
        updateChart();

</script>